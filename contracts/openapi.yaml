openapi: 3.1.0
info:
  title: Drishti_IC
  description: |
    Backend APIs for Drishti IC
    
  version: 2.0.0
  contact:
    name: Backend APIs

servers:
  - url: http://localhost:8000
    description: Local Development Server

tags:
  - name: Core Inspection
    description: Primary scanning and verification endpoints
  - name: IC Database
    description: Golden Record IC specifications
  - name: Datasheet Management
    description: Download datasheets from manufacturer websites
  - name: Scan History
    description: Audit trail of all scans
  - name: Dashboard
    description: Statistics and analytics
  - name: Datasheet Queue
    description: Pending ICs for online scraping
  - name: Fake Registry
    description: Known counterfeit IC numbers
  - name: Sync Operations
    description: Weekly online sync job management
  - name: Settings
    description: System configuration
  - name: System
    description: Health checks and system status
  - name: Camera
    description: AOI camera feed and capture control

paths:
  # ================================================================
  # CORE INSPECTION ENDPOINTS
  # ================================================================
  /api/v1/scan:
    post:
      tags: [Core Inspection]
      summary: Upload Image for Inspection
      operationId: scanImage
      description: |
        Primary endpoint. Uploads an IC image for verification.
        Performs OCR to read text and Vision to count pins.
        
        Returns one of:
        - **PASS**: IC matches golden record
        - **FAIL**: Pin count mismatch (possible relabeled chip)
        - **PARTIAL**: Need bottom scan (BTC components)
        - **UNKNOWN**: IC not in database (added to sync queue)
        - **COUNTERFEIT**: IC is in fake registry
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: JPEG/PNG image of the IC
      responses:
        '200':
          description: Inspection completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScanResult'
              examples:
                Pass:
                  summary: IC verified successfully (database match)
                  value:
                    scan_id: "550e8400-e29b-41d4-a716-446655440000"
                    status: "PASS"
                    action_required: "NONE"
                    confidence_score: 94.5
                    ocr_text: "LM555CN\nTI\n2024"
                    part_number: "LM555CN"
                    part_number_candidates:
                      - "LM555CN"
                      - "TI"
                      - "2024"
                      - "LM555CNTI"
                      - "TI2024"
                      - "LM555CNTI2024"
                    part_number_source: "database_match"
                    manufacturer_detected: "Texas Instruments"
                    detected_pins: 8
                    message: "IC verified successfully. All parameters match."
                    match_details:
                      part_number_match: true
                      pin_count_match: true
                      manufacturer_match: true
                    queued_for_sync: false
                    queued_candidates_count: 0
                    ic_specification:
                      part_number: "LM555"
                      manufacturer: "Texas Instruments"
                      pin_count: 8
                      package_type: "DIP"
                      description: "Precision Timer IC"
                      datasheet_path: "/datasheets/LM555.pdf"
                      has_datasheet: true
                    scanned_at: "2025-12-01T10:30:00Z"
                NeedBottomScan:
                  summary: Bottom-terminated component needs flip
                  value:
                    scan_id: "550e8400-e29b-41d4-a716-446655440001"
                    status: "PARTIAL"
                    action_required: "SCAN_BOTTOM"
                    confidence_score: 65.0
                    ocr_text: "ATMEL\nMEGA32U4\n-AU\n1035E KR"
                    part_number: "ATMEGA32U4-AU"
                    part_number_candidates:
                      - "ATMEL"
                      - "MEGA32U4"
                      - "-AU"
                      - "1035EKR"
                      - "ATMELMEGA32U4"
                      - "MEGA32U4-AU"
                      - "ATMEGA32U4-AU"
                    part_number_source: "database_match"
                    manufacturer_detected: "ATMEL"
                    detected_pins: 0
                    message: "Pins not visible. Please flip and scan the bottom."
                    queued_for_sync: false
                    queued_candidates_count: 0
                    scanned_at: "2025-12-01T10:32:00Z"
                Unknown:
                  summary: IC not in database (all candidates queued)
                  value:
                    scan_id: "550e8400-e29b-41d4-a716-446655440002"
                    status: "UNKNOWN"
                    action_required: "NONE"
                    confidence_score: 88.0
                    ocr_text: "XYZ9999\nABC\n2024"
                    part_number: "XYZ9999"
                    part_number_candidates:
                      - "XYZ9999"
                      - "ABC"
                      - "2024"
                      - "XYZ9999ABC"
                      - "ABC2024"
                      - "XYZ9999ABC2024"
                    part_number_source: "ocr_best_guess"
                    detected_pins: 16
                    message: "IC 'XYZ9999' not found in database. Added to sync queue."
                    queued_for_sync: true
                    queued_candidates_count: 6
                    ic_specification: null
                    scanned_at: "2025-12-01T10:35:00Z"
                Counterfeit:
                  summary: Known fake IC detected
                  value:
                    scan_id: "550e8400-e29b-41d4-a716-446655440003"
                    status: "COUNTERFEIT"
                    action_required: "NONE"
                    confidence_score: 100.0
                    ocr_text: "FAKE123"
                    part_number: "FAKE123"
                    part_number_candidates:
                      - "FAKE123"
                    part_number_source: "database_match"
                    detected_pins: 8
                    message: "ALERT: This IC is in the fake registry."
                    queued_for_sync: false
                    queued_candidates_count: 0
                    fake_registry_info:
                      added_at: "2025-11-15T08:00:00Z"
                      source: "SYNC_NOT_FOUND"
                      reason: "Not found on any manufacturer website"
                    scanned_at: "2025-12-01T10:40:00Z"
        '400':
          description: Invalid image or request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/scan/{scan_id}/bottom:
    post:
      tags: [Core Inspection]
      summary: Upload Bottom-View Image
      operationId: scanBottomImage
      description: |
        Used when initial scan returns `action_required: SCAN_BOTTOM`.
        For bottom-terminated components (QFN, BGA) where pins are underneath.
      parameters:
        - name: scan_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: The scan_id from the initial top scan
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Bottom scan processed and merged
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScanResult'
        '404':
          description: Scan ID not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "SCAN_NOT_FOUND"
                message: "No pending scan found with this ID."

  /api/v1/scan/override:
    post:
      tags: [Core Inspection]
      summary: Manual Part Number Correction
      operationId: manualOverride
      description: |
        Used when OCR fails to read the chip correctly.
        Operator types the correct part number manually.
        System still uses vision to verify pin count.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ManualOverrideRequest'
      responses:
        '200':
          description: Override processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScanResult'
        '404':
          description: Scan ID not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ================================================================
  # IC DATABASE ENDPOINTS
  # ================================================================
  /api/v1/ic/details:
    get:
      tags: [IC Database]
      summary: Get IC Specification
      operationId: getICDetails
      description: Fetch IC details from the Golden Record database.
      parameters:
        - name: part_number
          in: query
          required: true
          description: IC part number (e.g., LM334SM/NOPB)
          schema:
            type: string
          example: "LM555"
      responses:
        '200':
          description: IC found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ICSpecification'
        '404':
          description: IC not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "IC_NOT_FOUND"
                message: "Part number 'XYZ999' not found in database."
                suggestion: "This IC may be in the sync queue or fake registry."

  /api/v1/ic/datasheet:
    get:
      tags: [IC Database]
      summary: Download IC Datasheet PDF
      operationId: getICDatasheet
      description: Stream the locally stored PDF datasheet for an IC.
      parameters:
        - name: part_number
          in: query
          required: true
          description: IC part number (e.g., LM334SM/NOPB)
          schema:
            type: string
          example: "LM555"
      responses:
        '200':
          description: PDF file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        '404':
          description: Datasheet not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "DATASHEET_NOT_FOUND"
                message: "Datasheet for 'LM555' not available locally."

  /api/v1/ic/search:
    get:
      tags: [IC Database]
      summary: Search ICs (text search with filters)
      operationId: searchICs
      description: |
        Text search for ICs with optional filters and sorting.
        
        Use this when a user types into the search bar. Supports the same
        pagination, filtering, and sorting options as `/api/v1/ic/list`.
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query
          example: "555"
        - name: manufacturer
          in: query
          schema:
            type: string
          description: Filter by manufacturer (substring match)
          example: "Texas"
        - name: package_type
          in: query
          schema:
            type: string
          description: Filter by package type (e.g., DIP, SOIC, QFN)
          example: "SOIC"
        - name: min_pins
          in: query
          schema:
            type: integer
            minimum: 1
            default: 2
          description: Minimum pin count filter (default 2 to filter invalid entries)
          example: 2
        - name: max_pins
          in: query
          schema:
            type: integer
            minimum: 1
          description: Maximum pin count filter
          example: 64
        - name: sort_by
          in: query
          schema:
            $ref: '#/components/schemas/ICSortBy'
          description: "Field to sort by: part_number, manufacturer, pin_count, package_type, updated_at, created_at"
          example: "part_number"
        - name: sort_dir
          in: query
          schema:
            $ref: '#/components/schemas/SortDirection'
          description: Sort direction
          example: "asc"
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ICSearchResult'

  /api/v1/ic/list:
    get:
      tags: [IC Database]
      summary: List ICs (browse with filters)
      operationId: listICs
      description: |
        Browse the IC catalog with pagination, filtering, and sorting.
        Use this for table views when no free-text search is provided.
      parameters:
        - name: manufacturer
          in: query
          schema:
            type: string
          description: Filter by manufacturer (substring match)
          example: "Microchip"
        - name: package_type
          in: query
          schema:
            type: string
          description: Filter by package type (e.g., DIP, SOIC, QFN)
          example: "QFN"
        - name: min_pins
          in: query
          schema:
            type: integer
            minimum: 1
            default: 2
          description: Minimum pin count filter (default 2 to filter invalid entries)
          example: 2
        - name: max_pins
          in: query
          schema:
            type: integer
            minimum: 1
          description: Maximum pin count filter
          example: 128
        - name: sort_by
          in: query
          schema:
            $ref: '#/components/schemas/ICSortBy'
          description: "Field to sort by: part_number, manufacturer, pin_count, package_type, updated_at, created_at"
          example: "part_number"
        - name: sort_dir
          in: query
          schema:
            $ref: '#/components/schemas/SortDirection'
          description: Sort direction
          example: "desc"
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
          description: Page size
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Zero-based offset
      responses:
        '200':
          description: List results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ICSearchResult'
              example:
                results:
                  - part_number: "LM555CN"
                    manufacturer: "TI"
                    manufacturer_name: "Texas Instruments"
                    pin_count: 8
                    package_type: "DIP"
                    description: "Precision Timer IC"
                    has_datasheet: true
                  - part_number: "STM32F407"
                    manufacturer: "STM"
                    manufacturer_name: "STMicroelectronics"
                    pin_count: 100
                    package_type: "LQFP"
                    description: "ARM Cortex-M4 MCU"
                    has_datasheet: true
                total_count: 248
                limit: 20
                offset: 0

  # ================================================================
  # DATASHEET MANAGEMENT ENDPOINTS
  # ================================================================
  /api/v1/datasheets/download:
    post:
      tags: [Datasheet Management]
      summary: Download Datasheet from Manufacturer
      operationId: downloadDatasheet
      description: |
        Download IC datasheet from manufacturer websites and extract data.
        
        **Supported Manufacturers (enum):**
        - `STM` - STMicroelectronics
        - `TI` - Texas Instruments
        
        **Behavior:**
        - If `manufacturer` is provided: Downloads from that specific manufacturer
        - If `manufacturer` is omitted: Tries ALL manufacturers in parallel
        - Same IC can exist from multiple manufacturers → creates multiple DB entries
        
        **URL Patterns:**
        - STM: `https://www.st.com/resource/en/datasheet/{part_number}.pdf`
        - TI: `https://www.ti.com/lit/ds/symlink/{part_number}.pdf`
        
        **Flow:**
        1. Download PDF from manufacturer website(s)
        2. Extract IC specifications from PDF
        3. Store extracted data in `ic_specifications` table
        4. Save PDF to local storage
        5. Return results with manufacturers found
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DatasheetDownloadRequest'
            examples:
              WithManufacturer:
                summary: Download from specific manufacturer
                value:
                  part_number: "LM555"
                  manufacturer: "TI"
              WithoutManufacturer:
                summary: Try all manufacturers (parallel)
                value:
                  part_number: "LM555"
      responses:
        '200':
          description: Download completed (may have partial success)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatasheetDownloadResponse'
              examples:
                SingleManufacturer:
                  summary: Single manufacturer success
                  value:
                    success: true
                    part_number: "LM555"
                    manufacturers_found: ["TI"]
                    manufacturers_tried: ["TI"]
                    manufacturers_failed: []
                    results:
                      - manufacturer: "TI"
                        manufacturer_name: "Texas Instruments"
                        status: "SUCCESS"
                        file_path: "/datasheets/ti/lm555.pdf"
                        file_size_bytes: 1245678
                        datasheet_url: "https://www.ti.com/lit/ds/symlink/lm555.pdf"
                        data_extracted: true
                    database_entries_created: 1
                    message: "Successfully downloaded and processed datasheet from TI"
                MultipleManufacturers:
                  summary: Multiple manufacturers found (parallel search)
                  value:
                    success: true
                    part_number: "LM555"
                    manufacturers_found: ["TI", "STM"]
                    manufacturers_tried: ["TI", "STM"]
                    manufacturers_failed: []
                    results:
                      - manufacturer: "TI"
                        manufacturer_name: "Texas Instruments"
                        status: "SUCCESS"
                        file_path: "/datasheets/ti/lm555.pdf"
                        file_size_bytes: 1245678
                        datasheet_url: "https://www.ti.com/lit/ds/symlink/lm555.pdf"
                        data_extracted: true
                      - manufacturer: "STM"
                        manufacturer_name: "STMicroelectronics"
                        status: "SUCCESS"
                        file_path: "/datasheets/stm/lm555.pdf"
                        file_size_bytes: 987654
                        datasheet_url: "https://www.st.com/resource/en/datasheet/lm555.pdf"
                        data_extracted: true
                    database_entries_created: 2
                    message: "Found datasheet from 2 manufacturers"
                PartialSuccess:
                  summary: Partial success (some manufacturers failed)
                  value:
                    success: true
                    part_number: "STM32L031K6"
                    manufacturers_found: ["STM"]
                    manufacturers_tried: ["TI", "STM"]
                    manufacturers_failed: ["TI"]
                    results:
                      - manufacturer: "STM"
                        manufacturer_name: "STMicroelectronics"
                        status: "SUCCESS"
                        file_path: "/datasheets/stm/stm32l031k6.pdf"
                        file_size_bytes: 2345678
                        datasheet_url: "https://www.st.com/resource/en/datasheet/stm32l031k6.pdf"
                        data_extracted: true
                      - manufacturer: "TI"
                        manufacturer_name: "Texas Instruments"
                        status: "NOT_FOUND"
                        error: "Datasheet not found (HTTP 404)"
                    database_entries_created: 1
                    message: "Found datasheet from 1 manufacturer, 1 failed"
        '400':
          description: Invalid request or unsupported manufacturer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                InvalidManufacturer:
                  value:
                    error: "INVALID_MANUFACTURER"
                    message: "Manufacturer 'UNKNOWN_MFR' is not supported"
                    details:
                      provided: "UNKNOWN_MFR"
                      supported_manufacturers: ["STM", "TI"]
                InvalidPartNumber:
                  value:
                    error: "INVALID_PART_NUMBER"
                    message: "Part number is required and must be at least 2 characters"
        '404':
          description: Datasheet not found on any manufacturer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "DATASHEET_NOT_FOUND"
                message: "No datasheet found for 'XYZ999' on any supported manufacturer"
                details:
                  part_number: "XYZ999"
                  manufacturers_tried: ["STM", "TI"]

  /api/v1/datasheets/manufacturers:
    get:
      tags: [Datasheet Management]
      summary: List Supported Manufacturers
      operationId: listManufacturers
      description: |
        Get list of all supported manufacturers for datasheet downloads.
        Returns enum values and detailed information for each.
      responses:
        '200':
          description: List of supported manufacturers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManufacturerListResponse'
              example:
                manufacturers: ["STM", "TI"]
                count: 2
                details:
                  STM:
                    name: "STMicroelectronics"
                    url_pattern: "https://www.st.com/resource/en/datasheet/{part_number}.pdf"
                    example_ics: ["stm32l031k6", "stm32f407vg", "stm32h743zi"]
                  TI:
                    name: "Texas Instruments"
                    url_pattern: "https://www.ti.com/lit/ds/symlink/{part_number}.pdf"
                    example_ics: ["lm555", "lm358", "tps54620", "lm7805"]

  # ================================================================
  # SCAN HISTORY ENDPOINTS
  # ================================================================
  /api/v1/scans/list:
    get:
      tags: [Scan History]
      summary: List All Scans
      operationId: listScans
      description: Paginated list of all scan history with optional filters.
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [PASS, FAIL, PARTIAL, UNKNOWN, COUNTERFEIT]
        - name: date_from
          in: query
          schema:
            type: string
            format: date-time
        - name: date_to
          in: query
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 200
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Scan list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScanListResult'

  /api/v1/scans/{scan_id}/details:
    get:
      tags: [Scan History]
      summary: Get Scan Details
      operationId: getScanDetails
      description: Get full details of a specific scan including IC specification.
      parameters:
        - name: scan_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Scan details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScanDetails'
        '404':
          description: Scan not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ================================================================
  # DASHBOARD ENDPOINTS
  # ================================================================
  /api/v1/dashboard/stats:
    get:
      tags: [Dashboard]
      summary: Get Dashboard Statistics
      operationId: getDashboardStats
      description: Aggregate statistics for the dashboard.
      responses:
        '200':
          description: Statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardStats'

  # ================================================================
  # DATASHEET QUEUE ENDPOINTS
  # ================================================================
  /api/v1/queue/list:
    get:
      tags: [Datasheet Queue]
      summary: List Pending ICs
      operationId: listQueue
      description: |
        List ICs in the scraping queue with optional status filtering and pagination.
        
        Status options: PENDING, PROCESSING, FAILED
      parameters:
        - name: status
          in: query
          schema:
            type: array
            items:
              type: string
              enum: [PENDING, PROCESSING, FAILED]
          description: Filter by status(es). Can specify multiple values.
          example: ["PENDING", "FAILED"]
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            maximum: 500
          description: Maximum items to return
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Number of items to skip (for pagination)
      responses:
        '200':
          description: Queue list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueListResult'

  /api/v1/queue/add:
    post:
      tags: [Datasheet Queue]
      summary: Add ICs to Queue
      operationId: addToQueue
      description: |
        Manually add one or more part numbers to the sync queue.
        
        Use cases:
        - Add ICs manually for datasheet fetching
        - Bulk queue ICs from external source
        
        Duplicate entries will increment the scan_count instead of creating new entries.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueueAddRequest'
            examples:
              SingleIC:
                summary: Add single IC
                value:
                  part_numbers: ["LM555"]
                  source: "manual_entry"
              MultipleICs:
                summary: Add multiple ICs
                value:
                  part_numbers: ["LM555", "NE555", "STM32F407"]
                  source: "bulk_import"
      responses:
        '200':
          description: Items added to queue
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueAddResponse'
              example:
                success: true
                added_count: 2
                already_queued_count: 1
                message: "Added 2 new items to queue, updated 1 existing items."
                queued_items: ["LM555", "NE555", "STM32F407"]

  /api/v1/queue/{part_number}/remove:
    delete:
      tags: [Datasheet Queue]
      summary: Remove from Queue
      operationId: removeFromQueue
      description: Remove an IC from the sync queue (e.g., if added by mistake).
      parameters:
        - name: part_number
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Removed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Part number not in queue
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ================================================================
  # FAKE REGISTRY ENDPOINTS
  # ================================================================
  /api/v1/fakes/list:
    get:
      tags: [Fake Registry]
      summary: List Known Fakes
      operationId: listFakes
      description: List all IC numbers confirmed as fake/non-existent.
      responses:
        '200':
          description: Fake registry list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FakeListResult'

  /api/v1/fakes/mark:
    post:
      tags: [Fake Registry]
      summary: Mark IC as Fake
      operationId: markAsFake
      description: Manually add an IC number to the fake registry.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MarkFakeRequest'
      responses:
        '200':
          description: Added to fake registry
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FakeRegistryItem'
        '409':
          description: Already in fake registry
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/fakes/{part_number}/unmark:
    delete:
      tags: [Fake Registry]
      summary: Remove from Fake Registry
      operationId: unmarkFake
      description: Remove an IC from the fake registry (if marked by mistake).
      parameters:
        - name: part_number
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Removed from fake registry
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Part number not in fake registry
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/fakes/transfer-to-queue:
    post:
      tags: [Fake Registry]
      summary: Transfer Fakes to Queue
      operationId: transferFakesToQueue
      description: |
        Transfer all fake registry items to the scraping queue for retry.
        
        This will:
        1. Add all fake ICs to the datasheet_queue with status PENDING
        2. Remove them from the fake_registry
        
        Use this to retry scraping ICs that were previously marked as fake.
      responses:
        '200':
          description: Transfer completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransferToQueueResponse'

  # ================================================================
  # SYNC OPERATION ENDPOINTS
  # ================================================================
  /api/v1/sync/start:
    post:
      tags: [Sync Operations]
      summary: Start Weekly Sync
      operationId: startSync
      description: |
        Triggers background scraping job for all queued ICs.
        Requires internet connection.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncStartRequest'
      responses:
        '202':
          description: Sync job started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncJobInfo'
        '409':
          description: Sync already in progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "SYNC_IN_PROGRESS"
                message: "A sync job is already running."
                current_job_id: "660e8400-e29b-41d4-a716-446655440099"
                progress_percentage: 45

  /api/v1/sync/status:
    get:
      tags: [Sync Operations]
      summary: Get Sync Progress
      operationId: getSyncStatus
      description: Poll this endpoint to update the sync progress bar.
      responses:
        '200':
          description: Current sync status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncStatus'

  /api/v1/sync/cancel:
    post:
      tags: [Sync Operations]
      summary: Cancel Sync Job
      operationId: cancelSync
      description: Stop the currently running sync job.
      responses:
        '200':
          description: Sync cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: No sync job running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/sync/history:
    get:
      tags: [Sync Operations]
      summary: Get Sync History
      operationId: getSyncHistory
      description: List past sync job results.
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Sync history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncHistoryResult'

  # ================================================================
  # SETTINGS ENDPOINTS
  # ================================================================
  /api/v1/settings/list:
    get:
      tags: [Settings]
      summary: Get All Settings
      operationId: listSettings
      description: Get current system configuration.
      responses:
        '200':
          description: Settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settings'

  /api/v1/settings/update:
    patch:
      tags: [Settings]
      summary: Update Settings
      operationId: updateSettings
      description: Update one or more system settings.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SettingsUpdateRequest'
      responses:
        '200':
          description: Settings updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SettingsUpdateResponse'

  # ================================================================
  # SYSTEM ENDPOINTS
  # ================================================================
  /api/v1/health:
    get:
      tags: [System]
      summary: Health Check
      operationId: healthCheck
      description: Basic health check endpoint.
      responses:
        '200':
          description: System healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time

  /api/v1/system/status:
    get:
      tags: [System]
      summary: Detailed System Status
      operationId: getSystemStatus
      description: Comprehensive system status including database, camera, network, and storage.
      responses:
        '200':
          description: System status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemStatus'

  # ================================================================
  # CAMERA ENDPOINTS
  # ================================================================
  /api/v1/camera/feed:
    get:
      tags: [Camera]
      summary: WebSocket Video Feed
      operationId: cameraFeed
      description: |
        **WebSocket endpoint** for live video streaming.
        
        Connect: `ws://localhost:8000/api/v1/camera/feed`
        
        - Phone sends: Binary JPEG frames
        - Desktop receives: Binary JPEG frames
        - Server sends JSON events: CAMERA_CONNECTED, CAMERA_DISCONNECTED
      responses:
        '101':
          description: WebSocket upgrade

  /api/v1/camera/capture:
    post:
      tags: [Camera]
      summary: Trigger Frame Capture
      operationId: captureFrame
      description: |
        Desktop triggers capture of current frame from the video feed.
        The captured frame is then processed through the scan pipeline.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CaptureRequest'
      responses:
        '200':
          description: Frame captured, processing started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CaptureResponse'
        '503':
          description: Camera not connected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "CAMERA_NOT_CONNECTED"
                message: "No camera feed available. Please connect the AOI device."

# ================================================================
# COMPONENTS (SCHEMAS)
# ================================================================
components:
  schemas:
    # --------------------------------------------------
    # CORE SCAN SCHEMAS
    # --------------------------------------------------
    ScanResult:
      type: object
      description: Result of an IC scan operation
      properties:
        scan_id:
          type: string
          format: uuid
          description: Unique identifier for this scan
        status:
          type: string
          enum: [PASS, FAIL, PARTIAL, UNKNOWN, COUNTERFEIT]
          description: |
            - PASS: IC verified authentic
            - FAIL: Mismatch detected (wrong pin count)
            - PARTIAL: Need bottom scan
            - UNKNOWN: Not in database
            - COUNTERFEIT: In fake registry
        action_required:
          type: string
          enum: [NONE, SCAN_BOTTOM]
          description: Next action for the UI
        confidence_score:
          type: number
          format: float
          minimum: 0
          maximum: 100
          description: OCR/Vision confidence (0-100)
        ocr_text:
          type: string
          description: Raw text extracted from chip (newline-separated lines)
        part_number:
          type: string
          description: |
            Best-match or best-guess part number.
            - If database match found: the matched part number
            - If no match: heuristic-based best guess from candidates
        part_number_candidates:
          type: array
          nullable: true
          items:
            type: string
          description: |
            All part number candidates generated from OCR text.
            Includes single lines and adjacent line combinations (up to 4 lines).
            Example: ["ATMEL", "MEGA32U4", "-AU", "ATMELMEGA32U4", "MEGA32U4-AU", "ATMEGA32U4-AU"]
        part_number_source:
          $ref: '#/components/schemas/PartNumberSource'
        manufacturer_detected:
          type: string
          nullable: true
          description: Manufacturer if detected from text/logo
        detected_pins:
          type: integer
          description: Number of pins counted by vision
        message:
          type: string
          description: Human-readable result message
        match_details:
          $ref: '#/components/schemas/MatchDetails'
        queued_for_sync:
          type: boolean
          description: True if added to sync queue (status is UNKNOWN)
        queued_candidates_count:
          type: integer
          default: 0
          description: Number of candidates queued for sync (when no match found, all candidates are queued)
        ic_specification:
          $ref: '#/components/schemas/ICSpecification'
        fake_registry_info:
          $ref: '#/components/schemas/FakeRegistryInfo'
        was_manual_override:
          type: boolean
          default: false
          description: True if part number was manually corrected by operator
        scanned_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true

    MatchDetails:
      type: object
      nullable: true
      properties:
        part_number_match:
          type: boolean
        pin_count_match:
          type: boolean
          nullable: true
        manufacturer_match:
          type: boolean
          nullable: true

    ManualOverrideRequest:
      type: object
      required: [scan_id, manual_part_number]
      properties:
        scan_id:
          type: string
          format: uuid
          description: The scan to override
        manual_part_number:
          type: string
          description: Correct part number typed by operator
          example: "LM555"
        operator_note:
          type: string
          description: Optional note explaining the override

    # --------------------------------------------------
    # IC DATABASE SCHEMAS
    # --------------------------------------------------
    ICSpecification:
      type: object
      nullable: true
      description: |
        Golden Record IC specification.
        Note: Same part_number can have multiple entries from different manufacturers.
        Unique constraint is on (part_number, manufacturer) composite key.
      properties:
        part_number:
          type: string
          description: IC part number (e.g., "LM555", "STM32L031K6")
        manufacturer:
          type: string
          enum: [STM, TI]
          description: Manufacturer code (enum)
        manufacturer_name:
          type: string
          description: Full manufacturer name (e.g., "Texas Instruments")
        pin_count:
          type: integer
          description: Number of physical pins
        package_type:
          type: string
          description: Package format (DIP, QFN, BGA, SOIC, TSSOP, LQFP, etc.)
        description:
          type: string
          description: Brief description of IC function
        datasheet_url:
          type: string
          description: Original web URL where datasheet was downloaded
        datasheet_path:
          type: string
          description: Local file path to stored PDF
        has_datasheet:
          type: boolean
          description: Whether datasheet PDF is available locally
        voltage_min:
          type: number
          format: float
          description: Minimum operating voltage (V)
        voltage_max:
          type: number
          format: float
          description: Maximum operating voltage (V)
        operating_temp_min:
          type: number
          format: float
          description: Minimum operating temperature (°C)
        operating_temp_max:
          type: number
          format: float
          description: Maximum operating temperature (°C)
        electrical_specs:
          type: object
          additionalProperties: true
          description: Additional electrical specifications (flexible JSON)
        source:
          type: string
          enum: [MANUAL, SCRAPED_STM, SCRAPED_TI, SCRAPED_MOUSER, SCRAPED_DIGIKEY, SCRAPED_ALLDATASHEET]
          description: Data source identifier
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ICSortBy:
      type: string
      enum: [part_number, manufacturer, pin_count, package_type, updated_at, created_at]
      description: Allowed sort fields for IC list/search endpoints.

    SortDirection:
      type: string
      enum: [asc, desc]
      description: Sort direction for list/search endpoints.

    ICSearchResult:
      type: object
      properties:
        results:
          type: array
          items:
            type: object
            properties:
              part_number:
                type: string
              manufacturer:
                type: string
              manufacturer_name:
                type: string
              pin_count:
                type: integer
              package_type:
                type: string
              description:
                type: string
              has_datasheet:
                type: boolean
        total_count:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    # --------------------------------------------------
    # DATASHEET MANAGEMENT SCHEMAS
    # --------------------------------------------------
    ManufacturerEnum:
      type: string
      enum: [STM, TI]
      description: |
        Supported manufacturer codes.
        - STM: STMicroelectronics
        - TI: Texas Instruments

    DatasheetDownloadRequest:
      type: object
      required: [part_number]
      properties:
        part_number:
          type: string
          minLength: 2
          description: IC part number to download datasheet for
          example: "LM555"
        manufacturer:
          $ref: '#/components/schemas/ManufacturerEnum'
          description: |
            Optional. If provided, downloads only from this manufacturer.
            If omitted, tries ALL supported manufacturers in parallel.

    DatasheetDownloadResult:
      type: object
      description: Result for a single manufacturer download attempt
      properties:
        manufacturer:
          $ref: '#/components/schemas/ManufacturerEnum'
        manufacturer_name:
          type: string
          description: Full manufacturer name
          example: "Texas Instruments"
        status:
          type: string
          enum: [SUCCESS, NOT_FOUND, TIMEOUT, ERROR]
          description: Download status
        file_path:
          type: string
          nullable: true
          description: Local path where PDF was saved (if successful)
          example: "/datasheets/ti/lm555.pdf"
        file_size_bytes:
          type: integer
          nullable: true
          description: File size in bytes (if successful)
        datasheet_url:
          type: string
          nullable: true
          description: URL where datasheet was downloaded from
        data_extracted:
          type: boolean
          description: Whether IC data was successfully extracted from PDF
        error:
          type: string
          nullable: true
          description: Error message (if status is not SUCCESS)

    DatasheetDownloadResponse:
      type: object
      description: Response from datasheet download operation
      properties:
        success:
          type: boolean
          description: True if at least one manufacturer succeeded
        part_number:
          type: string
          description: The requested part number
        manufacturers_found:
          type: array
          items:
            $ref: '#/components/schemas/ManufacturerEnum'
          description: List of manufacturers where datasheet was found
        manufacturers_tried:
          type: array
          items:
            $ref: '#/components/schemas/ManufacturerEnum'
          description: List of all manufacturers attempted
        manufacturers_failed:
          type: array
          items:
            $ref: '#/components/schemas/ManufacturerEnum'
          description: List of manufacturers that failed
        results:
          type: array
          items:
            $ref: '#/components/schemas/DatasheetDownloadResult'
          description: Detailed results for each manufacturer attempted
        database_entries_created:
          type: integer
          description: Number of new entries added to ic_specifications table
        message:
          type: string
          description: Human-readable summary message

    ManufacturerDetail:
      type: object
      properties:
        name:
          type: string
          description: Full manufacturer name
        url_pattern:
          type: string
          description: URL pattern for datasheet downloads ({part_number} placeholder)
        example_ics:
          type: array
          items:
            type: string
          description: Example IC part numbers for this manufacturer

    ManufacturerListResponse:
      type: object
      properties:
        manufacturers:
          type: array
          items:
            $ref: '#/components/schemas/ManufacturerEnum'
          description: List of supported manufacturer codes
        count:
          type: integer
          description: Total number of supported manufacturers
        details:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ManufacturerDetail'
          description: Detailed information for each manufacturer

    # --------------------------------------------------
    # SCAN HISTORY SCHEMAS
    # --------------------------------------------------
    ScanListResult:
      type: object
      properties:
        scans:
          type: array
          items:
            type: object
            properties:
              scan_id:
                type: string
                format: uuid
              part_number:
                type: string
              status:
                type: string
                enum: [PASS, FAIL, PARTIAL, UNKNOWN, COUNTERFEIT]
              confidence_score:
                type: number
              detected_pins:
                type: integer
              scanned_at:
                type: string
                format: date-time
        total_count:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    ScanDetails:
      type: object
      properties:
        scan_id:
          type: string
          format: uuid
        ocr_text_raw:
          type: string
          description: Raw OCR output before cleanup
        part_number_detected:
          type: string
        part_number_verified:
          type: string
        status:
          type: string
          enum: [PASS, FAIL, PARTIAL, UNKNOWN, COUNTERFEIT]
        confidence_score:
          type: number
        detected_pins:
          type: integer
        expected_pins:
          type: integer
          nullable: true
        manufacturer_detected:
          type: string
        action_required:
          type: string
          enum: [NONE, SCAN_BOTTOM]
        has_bottom_scan:
          type: boolean
        was_manual_override:
          type: boolean
        match_details:
          $ref: '#/components/schemas/MatchDetails'
        failure_reasons:
          type: array
          nullable: true
          items:
            type: string
        message:
          type: string
        scanned_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        ic_specification:
          $ref: '#/components/schemas/ICSpecification'

    # --------------------------------------------------
    # DASHBOARD SCHEMAS
    # --------------------------------------------------
    DashboardStats:
      type: object
      properties:
        total_scans:
          type: integer
        scans_today:
          type: integer
        scans_this_week:
          type: integer
        pass_count:
          type: integer
        fail_count:
          type: integer
        unknown_count:
          type: integer
        counterfeit_count:
          type: integer
        pass_rate_percentage:
          type: number
          format: float
        queue_size:
          type: integer
          description: Pending ICs for sync
        fake_registry_size:
          type: integer
        database_ic_count:
          type: integer
          description: Total ICs in golden record
        last_sync_at:
          type: string
          format: date-time
          nullable: true
        last_sync_status:
          type: string
          enum: [IDLE, PROCESSING, COMPLETED, ERROR, CANCELLED]
          nullable: true
        recent_counterfeits:
          type: array
          items:
            type: object
            properties:
              part_number:
                type: string
              scanned_at:
                type: string
                format: date-time

    # --------------------------------------------------
    # DATASHEET QUEUE SCHEMAS
    # --------------------------------------------------
    QueueListResult:
      type: object
      properties:
        queue_items:
          type: array
          items:
            $ref: '#/components/schemas/QueueItem'
        total_count:
          type: integer
          description: Total count matching the filter
        pending_count:
          type: integer
          description: Total PENDING items in queue (regardless of filter)
        failed_count:
          type: integer
          description: Total FAILED items in queue (regardless of filter)
        limit:
          type: integer
          default: 100
        offset:
          type: integer
          default: 0

    QueueItem:
      type: object
      properties:
        part_number:
          type: string
        first_seen_at:
          type: string
          format: date-time
        last_scanned_at:
          type: string
          format: date-time
        scan_count:
          type: integer
          description: How many times scanned while unknown
        status:
          type: string
          enum: [PENDING, PROCESSING, FAILED]
        retry_count:
          type: integer
        error_message:
          type: string
          nullable: true

    QueueAddRequest:
      type: object
      required: [part_numbers]
      properties:
        part_numbers:
          type: array
          minItems: 1
          items:
            type: string
          description: List of part numbers to add to queue
        source:
          type: string
          nullable: true
          description: Optional source/reason for adding (e.g., "manual_entry", "bulk_import")

    QueueAddResponse:
      type: object
      properties:
        success:
          type: boolean
        added_count:
          type: integer
          description: Number of new items added
        already_queued_count:
          type: integer
          description: Number of items that were already in queue (scan_count incremented)
        message:
          type: string
        queued_items:
          type: array
          items:
            type: string
          description: List of part numbers that were added/updated

    # --------------------------------------------------
    # FAKE REGISTRY SCHEMAS
    # --------------------------------------------------
    FakeListResult:
      type: object
      properties:
        fake_ics:
          type: array
          items:
            $ref: '#/components/schemas/FakeRegistryItem'
        total_count:
          type: integer

    FakeRegistryItem:
      type: object
      properties:
        part_number:
          type: string
        source:
          type: string
          enum: [SYNC_NOT_FOUND, MANUAL_REPORT]
        reason:
          type: string
        reported_by:
          type: string
          nullable: true
        added_at:
          type: string
          format: date-time
        scrape_attempts:
          type: integer
        manufacturers_checked:
          type: array
          items:
            type: string

    FakeRegistryInfo:
      type: object
      nullable: true
      description: Info when IC is in fake registry
      properties:
        added_at:
          type: string
          format: date-time
        source:
          type: string
          enum: [SYNC_NOT_FOUND, MANUAL_REPORT]
        reason:
          type: string

    MarkFakeRequest:
      type: object
      required: [part_number, reason]
      properties:
        part_number:
          type: string
        reason:
          type: string
        reported_by:
          type: string

    TransferToQueueResponse:
      type: object
      properties:
        success:
          type: boolean
        transferred_count:
          type: integer
          description: Number of items transferred from fake registry to queue
        already_in_queue_count:
          type: integer
          description: Number of items that were already in queue
        message:
          type: string

    # --------------------------------------------------
    # SYNC SCHEMAS
    # --------------------------------------------------
    SyncStartRequest:
      type: object
      properties:
        max_items:
          type: integer
          description: Maximum items to process (optional)
        retry_failed:
          type: boolean
          default: true
          description: Retry previously failed items
        status_filter:
          type: array
          items:
            type: string
            enum: [PENDING, FAILED]
          description: Only sync items with these statuses
          example: ["PENDING"]

    SyncJobInfo:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [PROCESSING]
        message:
          type: string
        queue_size:
          type: integer
        estimated_time_minutes:
          type: integer

    SyncStatus:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
          nullable: true
        status:
          type: string
          enum: [IDLE, PROCESSING, COMPLETED, ERROR, CANCELLED]
        progress_percentage:
          type: integer
        current_item:
          type: string
          nullable: true
        total_items:
          type: integer
        processed_items:
          type: integer
        success_count:
          type: integer
        failed_count:
          type: integer
        fake_count:
          type: integer
          description: Items moved to fake registry
        started_at:
          type: string
          format: date-time
          nullable: true
        estimated_completion:
          type: string
          format: date-time
          nullable: true
        message:
          type: string
          nullable: true

    SyncHistoryResult:
      type: object
      properties:
        sync_jobs:
          type: array
          items:
            type: object
            properties:
              job_id:
                type: string
                format: uuid
              status:
                type: string
                enum: [COMPLETED, ERROR, CANCELLED]
              started_at:
                type: string
                format: date-time
              completed_at:
                type: string
                format: date-time
              total_items:
                type: integer
              success_count:
                type: integer
              failed_count:
                type: integer
              fake_count:
                type: integer
        total_count:
          type: integer

    # --------------------------------------------------
    # SETTINGS SCHEMAS
    # --------------------------------------------------
    Settings:
      type: object
      properties:
        settings:
          type: object
          properties:
            datasheet_folder_path:
              type: string
            auto_queue_unknown:
              type: boolean
            ocr_confidence_threshold:
              type: number
              format: float
            scan_history_retention_days:
              type: integer
            enable_auto_cleanup:
              type: boolean
            pin_detection_model:
              type: string
            ocr_model:
              type: string

    SettingsUpdateRequest:
      type: object
      additionalProperties: true
      description: Key-value pairs of settings to update
      example:
        scan_history_retention_days: 180
        ocr_confidence_threshold: 75.0

    SettingsUpdateResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        updated_settings:
          type: object
          additionalProperties: true

    # --------------------------------------------------
    # SYSTEM SCHEMAS
    # --------------------------------------------------
    SystemStatus:
      type: object
      properties:
        status:
          type: string
          enum: [operational, degraded, offline]
        database:
          type: object
          properties:
            connected:
              type: boolean
            ic_count:
              type: integer
        camera:
          type: object
          properties:
            connected:
              type: boolean
            last_frame_at:
              type: string
              format: date-time
              nullable: true
        network:
          type: object
          properties:
            internet_available:
              type: boolean
            last_checked:
              type: string
              format: date-time
        queue:
          type: object
          properties:
            pending_count:
              type: integer
            failed_count:
              type: integer
        storage:
          type: object
          properties:
            datasheet_folder:
              type: string
            datasheet_count:
              type: integer
            folder_size_mb:
              type: number
        last_sync:
          type: object
          nullable: true
          properties:
            job_id:
              type: string
              format: uuid
            status:
              type: string
            completed_at:
              type: string
              format: date-time

    # --------------------------------------------------
    # CAMERA SCHEMAS
    # --------------------------------------------------
    CaptureRequest:
      type: object
      required: [capture_type]
      properties:
        capture_type:
          type: string
          enum: [TOP, BOTTOM]
        scan_id:
          type: string
          format: uuid
          description: Required only for BOTTOM capture

    CaptureResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        scan_id:
          type: string
          format: uuid

    # --------------------------------------------------
    # COMMON SCHEMAS
    # --------------------------------------------------
    PartNumberSource:
      type: string
      enum: [database_match, ocr_best_guess, manual_override]
      default: ocr_best_guess
      description: |
        Indicates how the part_number was determined:
        - **database_match**: Part number was found in the IC database (verified)
        - **ocr_best_guess**: No database match; using heuristic-based best guess from OCR
        - **manual_override**: Operator manually corrected the part number

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        suggestion:
          type: string
          nullable: true
        details:
          type: object
          additionalProperties: true
          nullable: true
